package library.dao.repositories;

import library.domain.Author;
import library.domain.User;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;

public class UserRepository {

    Connection connection;
    private boolean tableexists;

    PreparedStatement insert;
    PreparedStatement selectByLogin;
    PreparedStatement selectById;

    public UserRepository(){

        try {
            connection = DriverManager.getConnection("jdbc:hsqldb:hsql://localhost/workdb");

            insert = connection.prepareStatement(""
                                                    +"INSERT INTO user(id,login,password,status)"
                                                    +"VALUES(?,?,?)");

            selectByLogin = connection.prepareStatement(""
                                                            + "SELECT * FROM user WHERE login=?");

            selectById = connection.prepareStatement(""
                                                        +"SELECT * FROM user WHERE id=?");

            ResultSet rs = connection.getMetaData().getTables(null,null,null,null);

            while(rs.next()){
                if (rs.getString("TABLE_NAME").equalsIgnoreCase("user")){
                    tableexists = true;
                    break;
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

    public User getByLogin(String login){
        User user = null;

        try {
            selectByLogin.setString(1, login);
            ResultSet rs = selectByLogin.executeQuery();
            while (rs.next()) {
                user = new User();
                user.setLogin(rs.getString("login"));
                user.setPassword(rs.getString("password"));
                user.setStatus(rs.getBoolean("status"));

            }

        } catch (SQLException e){
            e.printStackTrace();
        }

        return user;
    }

    public User getById(int id){
        User user = null;

        try {
            selectById.setInt(1, id);
            ResultSet rs = selectById.executeQuery();
            while(rs.next()){
                user= new User();
                user.setLogin(rs.getString("login"));
                user.setPassword(rs.getString("password"));
                user.setStatus(rs.getBoolean("status"));
                user.setId(rs.getInt("id"));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }

        return user;
    }

    public void add(User user){

        try {
            insert.setString(1, user.getLogin());
            insert.setString(2, user.getPassword());
            insert.setBoolean(3, user.isStatus());
            insert.executeUpdate();
        } catch (SQLException e){
            e.printStackTrace();
        }
    }

    public void createTable(){
        String createTableSql = "CREATE TABLE user("
                +"id bigint GENERATED BY DEFAULT AS IDENTITY,"
                +"login VARCHAR(20) NOT NULL,"
                +"password VARCHAR(20) NOT NULL,"
                +"status bit NOT NULL"
                +")";

        try {
            Statement createTable = connection.createStatement();
            if(!tableexists){
                createTable.executeUpdate(createTableSql);
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

}