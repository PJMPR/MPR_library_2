package library.dao.repositories;

import library.domain.Author;
import library.domain.User;

import java.sql.Connection;
import java.sql.DriverManager;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.sql.Statement;
import java.util.ArrayList;
import java.util.List;

public class UserRepository {

    Connection connection;
    private boolean tableexists;

    PreparedStatement insert;
    PreparedStatement selectByLogin;
    PreparedStatement selectById;
    PreparedStatement lastId;
    PreparedStatement selectByPage;
    PreparedStatement count;

    public UserRepository(){

        try {
            connection = DriverManager.getConnection("jdbc:hsqldb:hsql://localhost/workdb");

            insert = connection.prepareStatement(""
                                                    +"INSERT INTO user(login,password,status)"
                                                    +"VALUES(?,?,?)");

            selectByLogin = connection.prepareStatement(""
                                                            + "SELECT * FROM user WHERE login=?");

            selectById = connection.prepareStatement(""
                                                        +"SELECT * FROM user WHERE id=?");
            lastId = connection.prepareStatement(""
            										+ "SELECT MAX(id) FROM user"
            										+ "");
            selectByPage = connection.prepareStatement(""
					+ "SELECT * FROM user OFFSET ? LIMIT ?"
					+ "");		
            count = connection.prepareStatement(""
					+ "SELECT COUNT(*) FROM user"
					+ "");

            ResultSet rs = connection.getMetaData().getTables(null,null,null,null);

            while(rs.next()){
                if (rs.getString("TABLE_NAME").equalsIgnoreCase("user")){
                    tableexists = true;
                    break;
                }
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }
    
    public int count(){
		
		try {
			ResultSet rs = count.executeQuery();
			while(rs.next())
				return rs.getInt(1);
			
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return 0;
	}
	public int lastId(){
		
		try {
			ResultSet rs = lastId.executeQuery();
			while(rs.next())
				return rs.getInt(1);
			
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return 0;
	}

    public User getByLogin(String login){
        User user = null;

        try {
            selectByLogin.setString(1, login);
            ResultSet rs = selectByLogin.executeQuery();
            while (rs.next()) {
                user = new User();
                user.setLogin(rs.getString("login"));
                user.setPassword(rs.getString("password"));
                user.setStatus(rs.getBoolean("status"));

            }

        } catch (SQLException e){
            e.printStackTrace();
        }

        return user;
    }

    public User getById(int id){
        User user = null;

        try {
            selectById.setInt(1, id);
            ResultSet rs = selectById.executeQuery();
            while(rs.next()){
                user= new User();
                user.setLogin(rs.getString("login"));
                user.setPassword(rs.getString("password"));
                user.setStatus(rs.getBoolean("status"));
                user.setId(rs.getInt("id"));
            }
        } catch (SQLException e) {
            e.printStackTrace();
        }

        return user;
    }
    
    public List<User> getPage(int offset, int limit){
		
		List<User> result = new ArrayList<User>();
		try {
			selectByPage.setInt(1, offset);
			selectByPage.setInt(2, limit);
			ResultSet rs = selectByPage.executeQuery();
			while(rs.next()){
				User a = new User();
				a.setId(rs.getInt("id"));
				a.setLogin(rs.getString("login"));
				a.setPassword(rs.getString("password"));
				a.setStatus(rs.getBoolean("status"));
				result.add(a);
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}
		return result;
	}
    
    public User get(int id){
		User user = null;
				
		try {
			selectById.setInt(1, id);
			ResultSet rs = selectById.executeQuery();
			while(rs.next()){
				user = new User();
				user.setLogin(rs.getString("login"));
				user.setPassword(rs.getString("password"));
				user.setStatus(rs.getBoolean("status"));
				user.setId(rs.getInt("id"));
			}
		} catch (SQLException e) {
			e.printStackTrace();
		}		
				
		return user;
		
	}

    public void add(User user){

        try {
            insert.setString(1, user.getLogin());
            insert.setString(2, user.getPassword());
            insert.setBoolean(3, user.isStatus());
            insert.executeUpdate();
        } catch (SQLException e){
            e.printStackTrace();
        }
    }

    public void createTable(){
        String createTableSql = "CREATE TABLE user("
                +"id bigint GENERATED BY DEFAULT AS IDENTITY,"
                +"login VARCHAR(20) NOT NULL,"
                +"password VARCHAR(20) NOT NULL,"
                +"status bit NOT NULL"
                +")";

        try {
            Statement createTable = connection.createStatement();
            if(!tableexists){
                createTable.executeUpdate(createTableSql);
            }

        } catch (SQLException e) {
            e.printStackTrace();
        }
    }

}