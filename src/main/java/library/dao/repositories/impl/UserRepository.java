package library.dao.repositories.impl;


import library.dao.mappers.IMapper;
import library.dao.repositories.IUserRepository;
import library.dao.uow.IUnitOfWork;
import library.domain.User;

import java.sql.Connection;
import java.sql.PreparedStatement;
import java.sql.ResultSet;
import java.sql.SQLException;
import java.util.ArrayList;
import java.util.List;



public class UserRepository extends RepositoryBase<User>
	implements IUserRepository{

    	private PreparedStatement selectByLogin;
    	private PreparedStatement selectByStatus;
    

    	public UserRepository(Connection connection,IMapper<User> mapper, IUnitOfWork uow) throws SQLException {
    		super(connection,mapper, uow);
    		selectByLogin = connection.prepareStatement("SELECT * FROM user WHERE login=?");
    		selectByStatus = connection.prepareStatement("SELECT * FROM user WHERE status=?");
    	}
    	
    	@Override
		protected String createTableSql() {
			return "CREATE TABLE user("
			        +"id bigint GENERATED BY DEFAULT AS IDENTITY,"
			        +"login VARCHAR(20) NOT NULL,"
			        +"password VARCHAR(20) NOT NULL,"
			        +"status bit NOT NULL,"
			        +"admin bit NOT NULL"
			        +")";
		}

    	@Override
    	protected String getTableName() {
    		return "user";
    	}

    	@Override
    	protected String getUpdateSql() {
    		return "UPDATE user SET (login,password,status,admin)=(?,?,?,?) WHERE id=?";
    	}

    	@Override
    	protected String getInsertSql() {
    		return "INSERT INTO user(login,password,status,admin) VALUES(?,?,?,?)";
    	}
    	
    	@Override
    	protected void setInsert(User user) throws SQLException {
    		insert.setString(1, user.getLogin());
    		insert.setString(2, user.getPassword());
    		insert.setBoolean(3, user.isStatus());
    		insert.setBoolean(4, user.isAdmin());
    
    	}
    	@Override
    	protected void setUpdate(User user) throws SQLException {
    		update.setString(1, user.getLogin());
    		update.setString(2, user.getPassword());
    		update.setBoolean(3, user.isStatus());
    		update.setBoolean(4, user.isAdmin());
    		update.setInt(5, user.getId());
    	}

		public List<User> withStatus(boolean status) {
			
			List<User> Users = new ArrayList<User>();
			try {
				selectByStatus.setBoolean(1, status);
				ResultSet rs = selectByStatus.executeQuery();
				while(rs.next()){
					Users.add(_mapper.map(rs));
				}
			} catch (SQLException e) {
				e.printStackTrace();
			}
			return Users;
		}

		public List<User> withLogin(String login) {

			List<User> Users = new ArrayList<User>();
			try {
				selectByLogin.setString(1, login);
				ResultSet rs = selectByLogin.executeQuery();
				while(rs.next()){
					Users.add(_mapper.map(rs));
				}
				
			} catch (SQLException e) {
				e.printStackTrace();
			
			}
			return Users;
		}



}